{% extends 'base.html' %}
{% block title %}Process Document — AKN Distill{% endblock %}

{% block content %}
<h1 class="mb-3">Process Document</h1>

<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-upload" data-bs-toggle="tab" data-bs-target="#pane-upload" type="button" role="tab">Upload</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-preview" data-bs-toggle="tab" data-bs-target="#pane-preview" type="button" role="tab">Preview</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-download" data-bs-toggle="tab" data-bs-target="#pane-download" type="button" role="tab">Download</button>
  </li>
</ul>

<div class="card border-0 shadow-sm">
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" id="processForm">
      {% csrf_token %}

      <div class="tab-content">
        <!-- Upload -->
        <div class="tab-pane fade show active" id="pane-upload" role="tabpanel" aria-labelledby="tab-upload">
          <div class="mb-4">
            <label for="document" class="form-label">Upload Document (.docx)</label>
            <input type="file" class="form-control" id="document" name="document" accept=".docx" required>
            <div class="form-text">Tip: Latest AKN-formatted output gives best results.</div>
          </div>

          <div class="mb-4">
            <label for="description" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Short note to identify this document..."></textarea>
          </div>

          <button type="button" class="btn btn-outline-primary" id="toPreview">
            Next: Preview <i class="bi bi-arrow-right-short ms-1"></i>
          </button>
        </div>

        <!-- Preview -->
        <div class="tab-pane fade" id="pane-preview" role="tabpanel" aria-labelledby="tab-preview">
          <div class="row g-4">
            <div class="col-lg-7">
              <div class="border rounded p-3">
                <h6 class="mb-2">Quick Preview</h6>
                <p class="text-muted small mb-2" id="fileInfo">No file selected yet.</p>
                <div class="alert alert-secondary py-2 mb-0">
                  Browser preview for .docx is limited. You can still select rules and apply formatting.
                </div>
              </div>
            </div>

            <div class="col-lg-5">
              <h6 class="mb-3">Processing Rules</h6>

              <div class="form-check mb-2">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="fix_aos_all_parts" id="rule1" checked>
                <label class="form-check-label" for="rule1">Add em-dash in section listings</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="follow_number_with_none_level2" id="rule2">
                <label class="form-check-label" for="rule2">Remove space after list numbers</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="follow_number_with_none_level3" id="rule3">
                <label class="form-check-label" for="rule3">Fix paragraph indentation (0.5 cm hanging)</label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="tighten_level3_spacing" id="rule4">
                <label class="form-check-label" for="rule4">Tighten level 3 spacing</label>
              </div>

              <button type="submit" id="applyBtn" class="btn btn-primary" disabled>
                <i class="bi bi-magic me-1"></i> Apply Formatting
              </button>
            </div>
          </div>

          <!-- Inline status -->
          <div id="statusWrap" class="mt-4" style="display:none;">
            <div class="progress mb-2">
              <div class="progress-bar progress-bar-striped progress-bar-animated" style="width:100%"></div>
            </div>
            <div class="small text-muted" id="statusText">Processing…</div>
          </div>
        </div>

        <!-- Download -->
        <div class="tab-pane fade" id="pane-download" role="tabpanel" aria-labelledby="tab-download">
          <p class="text-muted">Once processing completes you can choose a format:</p>
          <div class="d-flex gap-2">
            <a href="#" id="dlPdf" class="btn btn-success disabled" aria-disabled="true">
              <i class="bi bi-filetype-pdf me-1"></i> PDF
            </a>
            <a href="#" id="dlDocx" class="btn btn-outline-secondary disabled" aria-disabled="true" title="Coming soon">
              <i class="bi bi-filetype-docx me-1"></i> DOCX
            </a>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('processForm');
  const toPreviewBtn = document.getElementById('toPreview');
  const previewTabBtn = document.getElementById('tab-preview');
  const downloadTabBtn = document.getElementById('tab-download');

  const applyBtn = document.getElementById('applyBtn');
  const fileInput = document.getElementById('document');
  const fileInfo = document.getElementById('fileInfo');

  const statusWrap = document.getElementById('statusWrap');
  const statusText = document.getElementById('statusText');
  const dlPdf = document.getElementById('dlPdf');
  const dlDocx = document.getElementById('dlDocx');

  // Move to Preview tab only if a file is chosen
  toPreviewBtn?.addEventListener('click', () => {
    if(!fileInput.files.length){
      alert('Please choose a .docx file first.');
      return;
    }
    const f = fileInput.files[0];
    fileInfo.textContent = `${f.name} • ${(f.size/1024/1024).toFixed(2)} MB`;
    new bootstrap.Tab(previewTabBtn).show();
  });

  // Enable Apply button when any rule is checked
  const syncApply = () => {
    const any = Array.from(document.querySelectorAll('.rule-checkbox')).some(cb => cb.checked);
    applyBtn.disabled = !any;
  };
  document.querySelectorAll('.rule-checkbox').forEach(cb => cb.addEventListener('change', syncApply));
  syncApply();

  // Intercept submit to avoid navigating to JSON
  form.addEventListener('submit', async function(e){
    e.preventDefault();

    if(!fileInput.files.length){
      alert('Please choose a .docx file first.');
      return;
    }

    applyBtn.disabled = true;
    statusWrap.style.display = 'block';
    statusText.textContent = 'Starting…';

    try {
      const fd = new FormData(form);
      const res = await fetch('', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to start processing');
      if (!data.document_id) throw new Error('No document id returned');

      pollStatus(data.document_id);
    } catch (err) {
      statusText.textContent = 'Error: ' + err.message;
      applyBtn.disabled = false;
    }
  });

  // Poll the status endpoint until complete
  async function pollStatus(id){
    let tries = 0, maxTries = 60 * 5; // 5 minutes
    const tick = async () => {
      try {
        const res = await fetch(`/document/${id}/status/`);
        const data = await res.json();

        if (data.is_complete){
          if (data.status === 'COMPLETED'){
            statusText.textContent = 'Completed.';
            // Enable PDF download
            if (data.processed_file_url){
              dlPdf.classList.remove('disabled');
              dlPdf.removeAttribute('aria-disabled');
              dlPdf.href = data.processed_file_url;
            }
            // Switch to Download tab
            new bootstrap.Tab(downloadTabBtn).show();

            // Optional: take user to detail page after 2.5s
            setTimeout(()=>{ window.location.href = `/document/${id}/`; }, 2500);
          } else {
            statusText.textContent = data.error_message || 'Processing failed.';
            applyBtn.disabled = false;
          }
          return;
        }

        tries++;
        statusText.textContent = 'Processing… (' + tries + 's)';
        if (tries < maxTries) setTimeout(tick, 1000);
        else {
          statusText.textContent = 'Timed out. Please open the document details page to check progress.';
          applyBtn.disabled = false;
        }
      } catch (e) {
        statusText.textContent = 'Polling error: ' + e.message;
        applyBtn.disabled = false;
      }
    };
    tick();
  }
})();
</script>
{% endblock %}
