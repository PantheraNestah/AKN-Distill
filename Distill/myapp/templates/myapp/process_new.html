{% extends 'base.html' %}
{% block title %}Process Document — AKN Distill{% endblock %}

{% block content %}
<h1 class="mb-3">Process Document</h1>

<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-upload" data-bs-toggle="tab" data-bs-target="#pane-upload" type="button" role="tab">Upload</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-preview" data-bs-toggle="tab" data-bs-target="#pane-preview" type="button" role="tab">Preview</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-download" data-bs-toggle="tab" data-bs-target="#pane-download" type="button" role="tab">Download</button>
  </li>
</ul>

<div class="card border-0 shadow-sm">
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" id="processForm">
      {% csrf_token %}

      <div class="tab-content">
        <!-- Upload -->
        <div class="tab-pane fade show active" id="pane-upload" role="tabpanel" aria-labelledby="tab-upload">
          <div class="mb-4">
            <label for="document" class="form-label">Upload Document (.docx)</label>
            <input type="file" class="form-control" id="document" name="document" accept=".docx" required>
            <div class="form-text">Tip: Latest AKN-formatted output gives best results.</div>
          </div>

          <div class="mb-4">
            <label for="description" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Short note to identify this document..."></textarea>
          </div>

          <button type="button" class="btn btn-outline-primary" id="toPreview">
            Next: Preview <i class="bi bi-arrow-right-short ms-1"></i>
          </button>
        </div>

        <!-- Preview -->
        <div class="tab-pane fade" id="pane-preview" role="tabpanel" aria-labelledby="tab-preview">
          <div class="row g-4">
            <div class="col-lg-7">
              <div class="border rounded p-3">
                <h6 class="mb-2">Quick Preview</h6>
                <p class="text-muted small mb-2" id="fileInfo">No file selected yet.</p>
                <div class="alert alert-secondary py-2 mb-0">
                  Browser preview for .docx is limited. You can still select rules and apply formatting.
                </div>
              </div>
            </div>

            <div class="col-lg-5">
              <h6 class="mb-3">Processing Rules</h6>

              <div class="form-check mb-2">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="no_space_after_number_all_lists_fix" id="rule1">
                <label class="form-check-label" for="rule1">
                  1. Remove Space After All List Numbers
                  <small class="text-muted d-block">Removes space after numbers in all list levels</small>
                </label>
              </div>

              <div class="form-check mb-2">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="enforce_list_left_indents_level1to3" id="rule2">
                <label class="form-check-label" for="rule2">
                  2. Enforce List Level Indents (1-3)
                  <small class="text-muted d-block">Sets consistent indents for list levels 1-3 (0.3, 0.6, 0.9 inches)</small>
                </label>
              </div>

              <div class="form-check mb-2">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="remove_all_tabs" id="rule3">
                <label class="form-check-label" for="rule3">
                  3. Remove All Tab Characters
                  <small class="text-muted d-block">Removes all tab characters to prevent formatting inconsistencies</small>
                </label>
              </div>

              <div class="form-check mb-2">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="lists_dot_to_emdash" id="rule4">
                <label class="form-check-label" for="rule4">
                  4. Convert List Numbers to Em Dashes (Pages 1-4)
                  <small class="text-muted d-block">Converts numbered list items to use em dashes instead of dots</small>
                </label>
              </div>

              <div class="form-check mb-2">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="remove_spaces_around_em_dash" id="rule5">
                <label class="form-check-label" for="rule5">
                  5. Remove Spaces Around Em Dashes
                  <small class="text-muted d-block">Removes extra spaces around em dashes for cleaner formatting</small>
                </label>
              </div>

              <div class="form-check mb-2">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="enforce_numeric_alignment_all_lists" id="rule6">
                <label class="form-check-label" for="rule6">
                  6. Enforce Numeric List Alignment
                  <small class="text-muted d-block">Ensures consistent right-alignment of numbers in all list levels</small>
                </label>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input rule-checkbox" type="checkbox" name="rules" value="add_space_before_emdash_paragraphs" id="rule7">
                <label class="form-check-label" for="rule7">
                  7. Add Space Before Em Dash Paragraphs
                  <small class="text-muted d-block">Adds leading space to paragraphs where second character is an em dash</small>
                </label>
              </div>

              <button type="submit" id="applyBtn" class="btn btn-primary" disabled>
                <i class="bi bi-magic me-1"></i> Apply Formatting
              </button>
            </div>
          </div>

          <!-- Inline status -->
          <div id="statusWrap" class="mt-4" style="display:none;">
            <h6 class="mb-3">Processing Progress</h6>
            
            <!-- Overall Progress Bar -->
            <div class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <small class="text-muted">Overall Progress</small>
                <small class="text-muted" id="progressPercent">0%</small>
              </div>
              <div class="progress" style="height: 20px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width:0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                  0%
                </div>
              </div>
            </div>
            
            <!-- Individual Task Status -->
            <div id="taskList" class="small">
              <!-- Task items will be inserted here -->
            </div>
            
            <div class="small text-muted mt-2" id="statusText">Starting...</div>
          </div>
        </div>

        <!-- Download -->
        <div class="tab-pane fade" id="pane-download" role="tabpanel" aria-labelledby="tab-download">
          <div class="alert alert-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Processing Complete!</strong> Your document is ready for download.
          </div>
          <p class="text-muted mb-3">Choose your preferred format:</p>
          <div class="d-flex gap-2">
            <a href="#" id="dlPdf" class="btn btn-danger disabled" aria-disabled="true">
              <i class="bi bi-filetype-pdf me-1"></i> Download PDF
            </a>
            <a href="#" id="dlDocx" class="btn btn-primary disabled" aria-disabled="true">
              <i class="bi bi-filetype-docx me-1"></i> Download DOCX
            </a>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('processForm');
  const toPreviewBtn = document.getElementById('toPreview');
  const previewTabBtn = document.getElementById('tab-preview');
  const downloadTabBtn = document.getElementById('tab-download');

  const applyBtn = document.getElementById('applyBtn');
  const fileInput = document.getElementById('document');
  const fileInfo = document.getElementById('fileInfo');

  const statusWrap = document.getElementById('statusWrap');
  const statusText = document.getElementById('statusText');
  const dlPdf = document.getElementById('dlPdf');
  const dlDocx = document.getElementById('dlDocx');

  // Move to Preview tab only if a file is chosen
  toPreviewBtn?.addEventListener('click', () => {
    if(!fileInput.files.length){
      alert('Please choose a .docx file first.');
      return;
    }
    const f = fileInput.files[0];
    fileInfo.textContent = `${f.name} • ${(f.size/1024/1024).toFixed(2)} MB`;
    new bootstrap.Tab(previewTabBtn).show();
  });

  // Enable Apply button when any rule is checked
  const syncApply = () => {
    const any = Array.from(document.querySelectorAll('.rule-checkbox')).some(cb => cb.checked);
    applyBtn.disabled = !any;
  };
  document.querySelectorAll('.rule-checkbox').forEach(cb => cb.addEventListener('change', syncApply));
  syncApply();

  // Intercept submit to avoid navigating to JSON
  form.addEventListener('submit', async function(e){
    e.preventDefault();

    if(!fileInput.files.length){
      alert('Please choose a .docx file first.');
      return;
    }

    applyBtn.disabled = true;
    statusWrap.style.display = 'block';
    statusText.textContent = 'Starting…';

    try {
      const fd = new FormData(form);
      const res = await fetch('', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to start processing');
      if (!data.document_id) throw new Error('No document id returned');

      pollStatus(data.document_id);
    } catch (err) {
      statusText.textContent = 'Error: ' + err.message;
      applyBtn.disabled = false;
    }
  });

  // Poll the status endpoint until complete
  async function pollStatus(id){
    let tries = 0, maxTries = 60 * 5; // 5 minutes
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const taskList = document.getElementById('taskList');
    
    const tick = async () => {
      try {
        const res = await fetch(`/document/${id}/status/`);
        const data = await res.json();

        // Update overall progress
        const progress = Math.round(data.progress || 0);
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = progress + '%';
        progressPercent.textContent = progress + '%';

        // Update task list
        if (data.tasks && data.tasks.length > 0) {
          taskList.innerHTML = data.tasks.map((task, index) => {
            const statusIcons = {
              'pending': '<i class="bi bi-clock text-muted"></i>',
              'processing': '<i class="bi bi-arrow-clockwise text-primary"></i>',
              'completed': '<i class="bi bi-check-circle-fill text-success"></i>',
              'failed': '<i class="bi bi-x-circle-fill text-danger"></i>'
            };
            
            const statusIcon = statusIcons[task.status] || '<i class="bi bi-dash"></i>';
            const statusClass = task.status === 'completed' ? 'text-success' : 
                               task.status === 'processing' ? 'text-primary fw-bold' :
                               task.status === 'failed' ? 'text-danger' : 'text-muted';
            
            return `
              <div class="d-flex align-items-center mb-2">
                <span class="me-2">${statusIcon}</span>
                <span class="${statusClass}">${index + 1}. ${task.rule_name.replace(/_/g, ' ')}</span>
                ${task.processing_time ? `<small class="text-muted ms-2">(${task.processing_time})</small>` : ''}
              </div>
              ${task.error_message ? `<div class="text-danger small ms-4 mb-2">${task.error_message}</div>` : ''}
            `;
          }).join('');
        }

        if (data.is_complete){
          if (data.status === 'COMPLETED'){
            statusText.textContent = 'All rules applied successfully!';
            
            // Enable BOTH PDF and DOCX downloads
            if (data.pdf_file_url){
              dlPdf.classList.remove('disabled');
              dlPdf.removeAttribute('aria-disabled');
              dlPdf.href = data.pdf_file_url;
            }
            
            if (data.processed_file_url){
              dlDocx.classList.remove('disabled');
              dlDocx.removeAttribute('aria-disabled');
              dlDocx.href = data.processed_file_url;
            }
            
            // Switch to Download tab
            new bootstrap.Tab(downloadTabBtn).show();

            // Optional: take user to detail page after 3 seconds
            setTimeout(()=>{ window.location.href = `/document/${id}/`; }, 3000);
          } else {
            statusText.textContent = data.error_message || 'Processing failed.';
            applyBtn.disabled = false;
          }
          return;
        }

        tries++;
        const currentTask = data.tasks?.find(t => t.status === 'processing');
        if (currentTask) {
          statusText.textContent = `Processing: ${currentTask.rule_name.replace(/_/g, ' ')}... (${tries}s)`;
        } else {
          statusText.textContent = 'Processing… (' + tries + 's)';
        }
        
        if (tries < maxTries) setTimeout(tick, 1000);
        else {
          statusText.textContent = 'Timed out. Please open the document details page to check progress.';
          applyBtn.disabled = false;
        }
      } catch (e) {
        statusText.textContent = 'Polling error: ' + e.message;
        applyBtn.disabled = false;
      }
    };
    tick();
  }
})();
</script>
{% endblock %}
